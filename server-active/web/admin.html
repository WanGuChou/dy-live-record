<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¸å¯è¯ç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .header p {
            color: #666;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .card h2 {
            margin-bottom: 20px;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        thead {
            background: #f8f9fa;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            font-weight: 600;
            color: #666;
            font-size: 14px;
        }
        td {
            font-size: 14px;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        .status-revoked {
            background: #d6d8db;
            color: #383d41;
        }
        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            display: none;
        }
        .result-box.show {
            display: block;
        }
        .result-box pre {
            margin: 10px 0 0 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” è®¸å¯è¯ç®¡ç†åå°</h1>
            <p>æŠ–éŸ³ç›´æ’­ç›‘æ§ç³»ç»Ÿ - License Authorization Service</p>
        </div>

        <!-- ç”Ÿæˆè®¸å¯è¯ -->
        <div class="card">
            <h2>ğŸ“ ç”Ÿæˆæ–°è®¸å¯è¯</h2>
            <form id="generateForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>å®¢æˆ· ID *</label>
                        <input type="text" name="customer_id" placeholder="ä¾‹å¦‚: customer_001" required>
                    </div>
                    <div class="form-group">
                        <label>è½¯ä»¶ ID</label>
                        <input type="text" name="software_id" value="dy-live-monitor" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æœ‰æ•ˆå¤©æ•° *</label>
                        <input type="number" name="expiry_days" value="365" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§æ¿€æ´»æ¬¡æ•°</label>
                        <input type="number" name="max_activations" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>è®¸å¯è¯ç±»å‹</label>
                        <select name="license_type">
                            <option value="full">æ­£å¼ç‰ˆ</option>
                            <option value="trial">è¯•ç”¨ç‰ˆ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>åŠŸèƒ½æƒé™ (JSON)</label>
                    <textarea name="features" rows="3" placeholder='{"max_rooms": 10, "export_data": true}'>{"max_rooms": 10, "export_data": true}</textarea>
                </div>
                <button type="submit" class="btn">ğŸ”‘ ç”Ÿæˆè®¸å¯è¯</button>
            </form>
            <div id="generateResult" class="result-box">
                <strong>âœ… è®¸å¯è¯ç”ŸæˆæˆåŠŸï¼</strong>
                <pre id="licenseData"></pre>
            </div>
        </div>

        <!-- è®¸å¯è¯åˆ—è¡¨ -->
        <div class="card">
            <h2>ğŸ“‹ è®¸å¯è¯åˆ—è¡¨</h2>
            <button class="btn" onclick="loadLicenses()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <table id="licenseTable">
                <thead>
                    <tr>
                        <th>è®¸å¯è¯ Key</th>
                        <th>å®¢æˆ· ID</th>
                        <th>è¿‡æœŸæ—¶é—´</th>
                        <th>æ¿€æ´»æ¬¡æ•°</th>
                        <th>ç±»å‹</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7" class="loading">ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ•°æ®</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';

        // ç”Ÿæˆè®¸å¯è¯
        document.getElementById('generateForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // è½¬æ¢æ•°å­—å­—æ®µ
            data.expiry_days = parseInt(data.expiry_days);
            data.max_activations = parseInt(data.max_activations || 1);
            
            // è§£æ features JSON
            try {
                data.features = JSON.parse(data.features || '{}');
            } catch (err) {
                alert('åŠŸèƒ½æƒé™ JSON æ ¼å¼é”™è¯¯: ' + err.message);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/licenses/generate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('generateResult').classList.add('show');
                    document.getElementById('licenseData').textContent = 
                        `è®¸å¯è¯ Key: ${result.license_key}\n\n` +
                        `è®¸å¯è¯æ•°æ®ï¼ˆäº¤ç»™å®¢æˆ·ï¼‰:\n${result.license_data}\n\n` +
                        `è¿‡æœŸæ—¶é—´: ${result.expiry_date}`;
                    
                    // é‡ç½®è¡¨å•
                    e.target.reset();
                    document.querySelector('[name="software_id"]').value = 'dy-live-monitor';
                    document.querySelector('[name="features"]').value = '{"max_rooms": 10, "export_data": true}';
                    
                    // åˆ·æ–°åˆ—è¡¨
                    loadLicenses();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + (result.error || result.message));
                }
            } catch (err) {
                alert('è¯·æ±‚å¤±è´¥: ' + err.message);
            }
        };

        // åŠ è½½è®¸å¯è¯åˆ—è¡¨
        async function loadLicenses() {
            const tbody = document.querySelector('#licenseTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';

            try {
                // æ³¨æ„ï¼šè¿™ä¸ªæ¥å£éœ€è¦åœ¨ server-active ä¸­å®ç°
                const response = await fetch(`${API_BASE}/licenses/list`);
                
                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const licenses = await response.json();
                
                if (licenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">æš‚æ— è®¸å¯è¯</td></tr>';
                    return;
                }

                tbody.innerHTML = licenses.map(lic => {
                    const statusClass = lic.status === 'active' ? 'status-active' : 
                                       lic.status === 'expired' ? 'status-expired' : 'status-revoked';
                    const statusText = lic.status === 'active' ? 'âœ… æ¿€æ´»' : 
                                      lic.status === 'expired' ? 'â° è¿‡æœŸ' : 'âŒ æ’¤é”€';
                    
                    return `
                        <tr>
                            <td><code>${lic.license_key}</code></td>
                            <td>${lic.customer_id}</td>
                            <td>${new Date(lic.expiry_date).toLocaleString('zh-CN')}</td>
                            <td>${lic.activation_count} / ${lic.max_activations}</td>
                            <td>${lic.license_type === 'full' ? 'æ­£å¼ç‰ˆ' : 'è¯•ç”¨ç‰ˆ'}</td>
                            <td><span class="status ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn" onclick="viewLicense('${lic.license_key}')" style="padding: 6px 12px; font-size: 12px;">æŸ¥çœ‹</button>
                                ${lic.status === 'active' ? 
                                    `<button class="btn btn-danger" onclick="revokeLicense('${lic.license_key}')" style="padding: 6px 12px; font-size: 12px;">æ’¤é”€</button>` 
                                    : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: red;">âŒ ${err.message}</td></tr>`;
            }
        }

        // æŸ¥çœ‹è®¸å¯è¯è¯¦æƒ…
        async function viewLicense(licenseKey) {
            try {
                const response = await fetch(`${API_BASE}/licenses/${licenseKey}`);
                const data = await response.json();
                
                if (response.ok) {
                    alert(
                        `è®¸å¯è¯è¯¦æƒ…:\n\n` +
                        `Key: ${data.license_key}\n` +
                        `å®¢æˆ·: ${data.customer_id}\n` +
                        `è½¯ä»¶: ${data.software_id}\n` +
                        `è¿‡æœŸæ—¶é—´: ${new Date(data.expiry_date).toLocaleString('zh-CN')}\n` +
                        `æ¿€æ´»æ¬¡æ•°: ${data.activation_count} / ${data.max_activations}\n` +
                        `ç±»å‹: ${data.license_type}\n` +
                        `çŠ¶æ€: ${data.status}`
                    );
                } else {
                    alert('æŸ¥è¯¢å¤±è´¥: ' + (data.error || data.message));
                }
            } catch (err) {
                alert('è¯·æ±‚å¤±è´¥: ' + err.message);
            }
        }

        // æ’¤é”€è®¸å¯è¯
        async function revokeLicense(licenseKey) {
            if (!confirm(`ç¡®å®šè¦æ’¤é”€è®¸å¯è¯ ${licenseKey} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/licenses/${licenseKey}/revoke`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert('âœ… è®¸å¯è¯å·²æ’¤é”€');
                    loadLicenses();
                } else {
                    alert('æ’¤é”€å¤±è´¥: ' + (data.error || data.message));
                }
            } catch (err) {
                alert('è¯·æ±‚å¤±è´¥: ' + err.message);
            }
        }
    </script>
</body>
</html>
