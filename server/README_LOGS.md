# WebSocket 日志记录功能

## 📁 日志目录结构

日志文件按照以下格式自动组织：

```
server/
└── logs/
    ├── 2025-11-15/
    │   ├── 16_7572969836067375906.log
    │   ├── 17_7572969836067375906.log
    │   └── 18_7573012345678901234.log
    ├── 2025-11-16/
    │   ├── 09_7573023456789012345.log
    │   └── 10_7573023456789012345.log
    └── ...
```

### 目录结构说明

- **第一层**: `年-月-日` (例如: `2025-11-15`)
- **文件名**: `时_房间号.log` (例如: `16_7572969836067375906.log`)

### 示例

- `2025-11-15/16_7572969836067375906.log` 
  - 日期: 2025年11月15日
  - 时间: 16点（下午4点）
  - 房间号: 7572969836067375906

## 📝 日志内容

每个日志文件包含：

### 1. 文件头信息

```
================================================================================
日志文件创建时间: 2025-11-15T16:24:37.271Z
房间ID: 7572969836067375906
WebSocket URL: wss://webcast100-ws-web-lf.douyin.com/webcast/im/push/v2/...
================================================================================
```

### 2. 消息记录

每条消息包含时间戳和格式化的内容：

```
[2025-11-15T16:24:37.271Z]
📥 接收消息
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 聊天消息
║ 时间: 2025-11-15T16:24:37.271Z
║ 用户: 张三
║ 内容: 你好，主播！
╚══════════════════════════════════════════════════════════════════════════════╝

[2025-11-15T16:24:38.123Z]
📥 接收消息
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 礼物消息
║ 时间: 2025-11-15T16:24:38.123Z
║ 用户: 李四
║ 礼物: 玫瑰花
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 3. 文件尾信息（关闭时）

```
================================================================================
日志文件关闭时间: 2025-11-15T16:59:59.999Z
================================================================================
```

## 🎯 功能特性

### 自动化管理

1. **自动创建目录**: 日期目录和日志文件自动创建
2. **按小时切换**: 每小时自动切换到新文件
3. **自动关闭**: 小时切换时自动关闭旧文件流
4. **优雅关闭**: 服务器关闭时自动关闭所有日志文件

### 智能过滤

- 只记录**抖音直播** WebSocket 消息
- 自动从 URL 中提取房间号
- 格式化的消息内容（与控制台输出一致）

### 性能优化

- 使用文件流（`fs.createWriteStream`）追加模式
- 缓存日志流，避免重复打开文件
- 定期清理过期的流（每小时）

## 🔧 配置

### 日志目录位置

默认位置：`server/logs/`

可以在 `server.js` 中修改：

```javascript
const logsDir = path.join(__dirname, 'logs');
```

### 修改为其他位置

```javascript
// 例如，使用项目根目录
const logsDir = path.join(__dirname, '..', 'dy-live-logs');

// 或使用绝对路径
const logsDir = '/var/log/dy-live-record';
```

## 📊 日志文件示例

### 完整日志文件示例

```
================================================================================
日志文件创建时间: 2025-11-15T16:24:37.271Z
房间ID: 7572969836067375906
WebSocket URL: wss://webcast100-ws-web-lf.douyin.com/webcast/im/push/v2/?room_id=7572969836067375906&...
================================================================================

[2025-11-15T16:24:37.271Z]
📥 接收消息
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 直播间统计
║ 时间: 2025-11-15T16:24:37.271Z
║ 提取信息: WebcastRoomStatsMessage, 3098, 3098在线观众
╚══════════════════════════════════════════════════════════════════════════════╝

[2025-11-15T16:24:37.274Z]
📥 接收消息
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 进入直播间
║ 时间: 2025-11-15T16:24:37.274Z
║ 用户: 用户A
╚══════════════════════════════════════════════════════════════════════════════╝

[2025-11-15T16:24:38.475Z]
📥 接收消息
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 关注消息
║ 时间: 2025-11-15T16:24:38.475Z
║ 用户: 用户B
║ 动作: 关注了主播
╚══════════════════════════════════════════════════════════════════════════════╝

... (更多消息) ...

================================================================================
日志文件自动关闭（小时切换）: 2025-11-15T16:59:59.999Z
================================================================================
```

## 🛠️ 使用方法

### 1. 启动服务器

```bash
cd server
npm start
```

服务器会自动：
- 创建 `logs/` 目录
- 开始记录抖音直播消息
- 按日期和小时组织日志文件

### 2. 查看日志

```bash
# 查看今天的日志
ls logs/2025-11-15/

# 查看特定小时的日志
cat logs/2025-11-15/16_7572969836067375906.log

# 实时查看日志（需要先找到正在写入的文件）
tail -f logs/2025-11-15/16_7572969836067375906.log
```

### 3. 日志文件管理

```bash
# 查看日志目录大小
du -sh logs/

# 查看所有日志文件
find logs/ -name "*.log"

# 删除7天前的日志
find logs/ -name "*.log" -mtime +7 -delete

# 压缩旧日志
find logs/ -name "*.log" -mtime +1 -exec gzip {} \;
```

## 📈 日志分析

### 统计某个房间的消息数量

```bash
# 统计聊天消息
grep "聊天消息" logs/2025-11-15/16_7572969836067375906.log | wc -l

# 统计礼物消息
grep "礼物消息" logs/2025-11-15/16_7572969836067375906.log | wc -l

# 统计点赞消息
grep "点赞消息" logs/2025-11-15/16_7572969836067375906.log | wc -l
```

### 提取用户信息

```bash
# 提取所有用户名
grep "用户:" logs/2025-11-15/16_7572969836067375906.log | sed 's/.*用户: //' | sort | uniq

# 提取所有聊天内容
grep "内容:" logs/2025-11-15/16_7572969836067375906.log | sed 's/.*内容: //'
```

## ⚠️ 注意事项

### 1. 磁盘空间

- 日志文件会持续增长，需要定期清理
- 建议每天/每周清理或压缩旧日志
- 高流量直播间可能产生大量日志

### 2. 性能影响

- 文件写入是异步的，对性能影响很小
- 使用了流式写入，内存占用低
- 建议定期关闭不活跃的日志流

### 3. 文件权限

- 确保服务器进程有写入 `logs/` 目录的权限
- Linux/macOS: `chmod -R 755 logs/`

### 4. 日志轮转

建议使用系统级日志轮转工具（如 `logrotate`）：

```bash
# /etc/logrotate.d/dy-live-record
/path/to/server/logs/*/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
```

## 🔍 故障排查

### 日志文件未创建

1. 检查 `logs/` 目录权限
2. 查看控制台是否有错误信息
3. 确认 WebSocket URL 包含 `room_id` 参数

### 房间号显示为 "unknown"

- URL 中没有 `room_id` 或 `wss_push_room_id` 参数
- 检查 `extractRoomId()` 函数的正则表达式

### 日志文件过大

- 实施日志轮转策略
- 定期压缩或删除旧日志
- 考虑使用日志聚合服务

## 🚀 高级功能

### 自定义日志格式

修改 `writeLog()` 函数：

```javascript
function writeLog(url, message) {
  // 添加自定义格式
  const customFormat = `[${timestamp}] Room: ${roomId}\n${message}\n`;
  logInfo.stream.write(customFormat);
}
```

### 添加日志级别

```javascript
function writeLog(url, message, level = 'INFO') {
  const logEntry = `[${timestamp}] [${level}] ${message}\n`;
  logInfo.stream.write(logEntry);
}
```

### 集成到日志服务

可以将日志发送到：
- ELK Stack (Elasticsearch, Logstash, Kibana)
- Splunk
- Grafana Loki
- AWS CloudWatch

## 📚 相关文档

- [Node.js fs 模块文档](https://nodejs.org/api/fs.html)
- [Node.js Streams](https://nodejs.org/api/stream.html)
- [抖音直播消息解析](./README_DOUYIN.md)

---

**版本**: v2.2.0  
**更新时间**: 2025-11-15  
**功能**: WebSocket 日志文件记录
