# 抖音直播 WebSocket 消息解析

## 📖 功能说明

服务器现在支持自动解析抖音直播的WebSocket消息，当监控到来自 `wss://webcast100-ws-web-hl.douyin.com` 的消息时，会自动解析并美化显示。

---

## 🎯 支持的消息类型

### 1. 聊天消息 (WebcastChatMessage)

**示例输出：**
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 聊天消息
║ 时间: 2025-11-15T16:00:00.000Z
║ 用户: 张三 [Lv.15]
║ 内容: 主播好厉害！
║ 徽章: 粉丝团, VIP
╚══════════════════════════════════════════════════════════════════════════════╝
```

**包含信息：**
- 用户昵称和等级
- 聊天内容
- 用户徽章

### 2. 礼物消息 (WebcastGiftMessage)

**示例输出：**
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 礼物消息
║ 时间: 2025-11-15T16:00:00.000Z
║ 用户: 李四
║ 礼物: 玫瑰花 x 10
║ 价值: 100 💎
║ 连击: 5
╚══════════════════════════════════════════════════════════════════════════════╝
```

**包含信息：**
- 送礼用户
- 礼物名称和数量
- 礼物价值（钻石）
- 连击次数

### 3. 点赞消息 (WebcastLikeMessage)

**示例输出：**
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 点赞消息
║ 时间: 2025-11-15T16:00:00.000Z
║ 用户: 王五
║ 点赞数: 100 ❤️
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 4. 进入直播间 (WebcastMemberMessage)

**示例输出：**
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 进入直播间
║ 时间: 2025-11-15T16:00:00.000Z
║ 用户: 赵六 [Lv.20]
║ 当前人数: 1234
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 5. 在线人数 (WebcastRoomUserSeqMessage)

**示例输出：**
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 在线人数
║ 时间: 2025-11-15T16:00:00.000Z
║ 在线人数: 5678 👥
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 6. 关注消息 (WebcastSocialMessage)

**示例输出：**
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 关注消息
║ 时间: 2025-11-15T16:00:00.000Z
║ 用户: 孙七
║ 动作: 关注了主播
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 📊 统计信息

服务器会自动统计抖音直播消息，每50条消息显示一次：

```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 📊 抖音直播统计
╠══════════════════════════════════════════════════════════════════════════════╣
║ 总消息数: 500
║ 聊天消息: 300
║ 礼物消息: 50
║ 点赞消息: 100
║ 进入直播间: 40
║ 当前在线: 1234 👥
║ 更新时间: 2025-11-15T16:00:00.000Z
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 🚀 使用方法

### 1. 启动服务器

```bash
cd server
npm install
npm start
```

### 2. 配置并启动插件

1. 在Chrome中加载CDP Monitor插件
2. 设置服务器地址: `ws://localhost:8080/monitor`
3. 启用监控
4. 保存配置

### 3. 打开抖音直播

1. 访问抖音直播间（例如：https://live.douyin.com/xxx）
2. 服务器会自动检测抖音直播WebSocket连接
3. 所有直播消息会被自动解析并美化显示

### 4. 查看解析结果

服务器终端会显示：

```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🔌 WebSocket 创建 #1 [抖音直播]
╠══════════════════════════════════════════════════════════════════════════════╣
║ 完整URL: wss://webcast100-ws-web-hl.douyin.com/webcast/im/...
║ 标签页ID: 123
║ 请求ID: 456.1
║ ⭐ 抖音直播WebSocket，将自动解析消息内容
║ 时间: 2025-11-15T16:00:00.000Z
╚══════════════════════════════════════════════════════════════════════════════╝

// 之后的所有消息都会被自动解析
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🎬 抖音直播消息
╠══════════════════════════════════════════════════════════════════════════════╣
║ 消息类型: 聊天消息
║ ...
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 🔧 技术细节

### 消息格式

抖音直播使用JSON格式传输消息（部分直播间可能使用Protobuf）。

**JSON格式示例：**
```json
{
  "method": "WebcastChatMessage",
  "user": {
    "id": "123456",
    "nickname": "张三",
    "level": 15
  },
  "content": "主播好厉害！"
}
```

### 检测逻辑

解析器通过URL判断是否为抖音直播WebSocket：

```javascript
// 检测条件
url.includes('webcast') && 
url.includes('douyin.com')
```

### 解析流程

1. 接收WebSocket消息
2. 检测URL是否为抖音直播
3. 解析消息内容（JSON格式）
4. 根据消息类型提取关键信息
5. 格式化输出

---

## 📝 代码示例

### 手动使用解析器

```javascript
const douyinParser = require('./dy_ws_msg');

// 检测是否为抖音直播WebSocket
const isDouyin = douyinParser.isDouyinLiveWS(url);

if (isDouyin) {
  // 解析消息
  const parsed = douyinParser.parseMessage(payloadData, url);
  
  // 格式化输出
  const formatted = douyinParser.formatMessage(parsed);
  console.log(formatted);
  
  // 获取统计信息
  const stats = douyinParser.getStatistics();
  console.log(stats);
}
```

---

## 🐛 故障排查

### Q1: 消息没有被解析

**检查：**
1. 确认访问的是抖音直播间
2. 查看服务器日志中是否有"抖音直播WebSocket"标记
3. 检查WebSocket URL是否包含 `webcast` 和 `douyin.com`

### Q2: 解析结果不完整

**原因：**
- 抖音可能使用Protobuf格式
- 消息格式可能有变化

**解决：**
- 查看原始消息内容
- 如果是Protobuf，需要.proto文件进行完整解析

### Q3: 统计信息不准确

**原因：**
- 某些消息类型未被识别
- 消息格式不标准

**解决：**
- 查看日志中的"未知消息类型"
- 可能需要更新解析器以支持新格式

---

## 🔮 未来改进

### 计划支持

- [ ] Protobuf 格式完整解析
- [ ] 更多消息类型（弹幕特效、主播通知等）
- [ ] 礼物价值统计（总钻石数）
- [ ] 高频用户统计
- [ ] 消息导出功能（CSV/JSON）
- [ ] 实时数据可视化

---

## 📚 相关资源

- **参考项目**: https://github.com/skmcj/dycast
- **抖音直播协议**: 基于WebSocket + JSON/Protobuf
- **CDP Monitor**: [../CDP_USAGE.md](../CDP_USAGE.md)

---

## 🤝 贡献

欢迎提交Issue和PR来：
- 支持更多消息类型
- 改进解析准确性
- 优化性能
- 添加新功能

---

**更新时间**: 2025-11-15  
**版本**: v2.0.0  
**支持协议**: WebSocket + JSON (部分Protobuf)
