# server-go - æŠ–éŸ³ç›´æ’­ç›‘æ§æ ¸å¿ƒåç«¯æœåŠ¡

## é¡¹ç›®çŠ¶æ€

**ğŸš§ å½“å‰å¤„äºå¼€å‘é˜¶æ®µ - æ¡†æ¶å·²æ­å»ºï¼Œæ ¸å¿ƒåŠŸèƒ½å¾…å®ç°**

æœ¬é¡¹ç›®æ˜¯å°†ç°æœ‰çš„ Node.js (`server`) é‡æ„ä¸º **Go è¯­è¨€**å®ç°çš„æ¡Œé¢åº”ç”¨ç¨‹åºã€‚

---

## âœ… å·²å®Œæˆ

### 1. é¡¹ç›®ç»“æ„
```
server-go/
â”œâ”€â”€ main.go                    # å…¥å£æ–‡ä»¶
â”œâ”€â”€ go.mod                     # Go æ¨¡å—ä¾èµ–
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/               # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ config.go
â”‚   â”œâ”€â”€ database/             # SQLite æ•°æ®åº“
â”‚   â”‚   â””â”€â”€ database.go
â”‚   â”œâ”€â”€ license/              # è®¸å¯è¯ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ license.go
â”‚   â”‚   â””â”€â”€ fingerprint.go
â”‚   â”œâ”€â”€ server/               # WebSocket æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ websocket.go
â”‚   â”œâ”€â”€ parser/               # æŠ–éŸ³æ¶ˆæ¯è§£æ
â”‚   â”‚   â””â”€â”€ douyin.go
â”‚   â””â”€â”€ ui/                   # ç³»ç»Ÿæ‰˜ç›˜ UI
â”‚       â””â”€â”€ systray.go
â””â”€â”€ README.md
```

### 2. æ ¸å¿ƒæ¨¡å—æ¡†æ¶

#### âœ… é…ç½®ç®¡ç† (config)
- æ”¯æŒ JSON é…ç½®æ–‡ä»¶
- é»˜è®¤é…ç½®ç”Ÿæˆ
- ç«¯å£ã€æ•°æ®åº“è·¯å¾„ã€è®¸å¯è¯æœåŠ¡å™¨ç­‰é…ç½®é¡¹

#### âœ… æ•°æ®åº“ (database)
- SQLite æ•°æ®åº“è‡ªåŠ¨åˆå§‹åŒ–
- å®Œæ•´çš„è¡¨ç»“æ„è®¾è®¡ï¼š
  - `rooms` - æˆ¿é—´ä¿¡æ¯
  - `live_sessions` - ç›´æ’­åœºæ¬¡
  - `gift_records` - ç¤¼ç‰©è®°å½•
  - `message_records` - æ¶ˆæ¯è®°å½•
  - `anchors` - ä¸»æ’­é…ç½®

#### âœ… è®¸å¯è¯ç³»ç»Ÿ (license)
- RSA 2048 æ•°å­—ç­¾åéªŒè¯
- ç¡¬ä»¶æŒ‡çº¹ç”Ÿæˆï¼ˆCPUã€ä¸»æ¿ã€ç¡¬ç›˜ã€MACåœ°å€ï¼‰
- NTP æ—¶é—´æ ¡éªŒï¼ˆé˜²æ­¢ç³»ç»Ÿæ—¶é—´ç¯¡æ”¹ï¼‰
- ç¦»çº¿æ ¡éªŒ + åœ¨çº¿æ¿€æ´»
- æœ¬åœ°è®¸å¯è¯å­˜å‚¨

#### âœ… WebSocket æœåŠ¡å™¨ (server)
- æ¥æ”¶æµè§ˆå™¨æ’ä»¶æ•°æ®
- å¤šæˆ¿é—´å¹¶å‘ç®¡ç†
- æ¶ˆæ¯åˆ†ç±»å¤„ç†ï¼ˆç¤¼ç‰©ã€èŠå¤©ã€è¿›å…¥ç›´æ’­é—´ç­‰ï¼‰
- æ•°æ®æŒä¹…åŒ–

#### âœ… ç³»ç»Ÿæ‰˜ç›˜ UI (ui)
- æ‰˜ç›˜å›¾æ ‡å’Œèœå•
- ä¸»ç•Œé¢ã€è®¾ç½®ã€è®¸å¯è¯ç®¡ç†å…¥å£ï¼ˆæ¡†æ¶ï¼‰

---

## ğŸš§ å¾…å®ç°ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

### 1. æŠ–éŸ³æ¶ˆæ¯è§£æå™¨ (parser/douyin.go)
**ä¼˜å…ˆçº§ï¼šâ­â­â­â­â­**

éœ€è¦å°† `server/dy_ws_msg.js` çš„å®Œæ•´ Protobuf è§£æé€»è¾‘ç§»æ¤åˆ° Goï¼š

- [ ] ByteBuffer å®ç°
- [ ] `decodePushFrame()`
- [ ] `decodeResponse()`
- [ ] `decodeMessage()`
- [ ] `decodeUser()`
- [ ] `decodeChatMessage()`
- [ ] `decodeGiftMessage()`
- [ ] `decodeGiftStruct()`
- [ ] `decodeLikeMessage()`
- [ ] `decodeMemberMessage()`
- [ ] GZIP è§£å‹ï¼ˆä½¿ç”¨ `compress/gzip`ï¼‰

**æŠ€æœ¯éš¾ç‚¹**ï¼š
- JavaScript çš„ `Uint8Array` â†’ Go çš„ `[]byte`
- Protobuf varint ç¼–ç è§£æ
- åµŒå¥—ç»“æ„é€’å½’è§£ç 

### 2. ä¸»ç•Œé¢ (webview2)
**ä¼˜å…ˆçº§ï¼šâ­â­â­â­**

ä½¿ç”¨ `webview_go` æˆ–çº¯ HTML/JS å®ç°ï¼š

- [ ] Tab æ ‡ç­¾é¡µï¼ˆå¤šæˆ¿é—´åˆ‡æ¢ï¼‰
- [ ] å®æ—¶æ•°æ®çœ‹æ¿
- [ ] ç¤¼ç‰©è®°å½•è¡¨æ ¼
- [ ] æ¶ˆæ¯è®°å½•åˆ—è¡¨
- [ ] å†å²è®°å½•æŸ¥è¯¢
- [ ] ä¸»æ’­ç®¡ç†ç•Œé¢
- [ ] ç¤¼ç‰©ç»‘å®šé…ç½®

### 3. Webview2 å¤‡ç”¨æ•°æ®é€šé“ (Fallback)
**ä¼˜å…ˆçº§ï¼šâ­â­â­**

å‚è€ƒ `dycast` å®ç°ï¼š

- [ ] åå°å¯åŠ¨ webview2 å®ä¾‹
- [ ] æ³¨å…¥ JavaScript è„šæœ¬
- [ ] æ‹¦æˆª WSS æ¶ˆæ¯
- [ ] è§£æå¹¶æ³¨å…¥ä¸»æ•°æ®æµ

### 4. æµè§ˆå™¨æ’ä»¶ç®¡ç†
**ä¼˜å…ˆçº§ï¼šâ­â­**

- [ ] å†…ç½®æ’ä»¶å‹ç¼©åŒ…
- [ ] ä¸€é”®å®‰è£…åŠŸèƒ½
- [ ] è‡ªåŠ¨æ£€æµ‹æµè§ˆå™¨è·¯å¾„
- [ ] å¯åŠ¨å‚æ•°é…ç½®ï¼ˆ`--silent-debugger-extension-api`ï¼‰

### 5. ä¸»æ’­ç®¡ç†ä¸ç¤¼ç‰©åˆ†é…
**ä¼˜å…ˆçº§ï¼šâ­â­**

- [ ] ä¸»æ’­å¢åˆ æ”¹æŸ¥
- [ ] ç¤¼ç‰©ç»‘å®šè§„åˆ™
- [ ] å¼¹å¹•æŒ‡ä»¤è¯†åˆ«ï¼ˆå¦‚ "@ä¸»æ’­A åˆ·ç«ç®­"ï¼‰
- [ ] è‡ªåŠ¨è®¡ç®—ä¸šç»©

### 6. æ•°æ®åˆ·æ–°ä¸åˆ†æ®µè®°åˆ†
**ä¼˜å…ˆçº§ï¼šâ­**

- [ ] æ‰‹åŠ¨åˆ·æ–°é’»çŸ³/ç§¯åˆ†
- [ ] åˆ†æ®µè®°åˆ†ï¼ˆå¿«ç…§å½“å‰ç»Ÿè®¡ï¼‰
- [ ] PK æ—¶æ®µåŒºåˆ†

---

## ğŸ“¦ ä¾èµ–åº“

```go
require (
	github.com/getlantern/systray v1.2.2          // ç³»ç»Ÿæ‰˜ç›˜
	github.com/gorilla/websocket v1.5.1           // WebSocket æœåŠ¡å™¨
	github.com/mattn/go-sqlite3 v1.14.18          // SQLite æ•°æ®åº“
	github.com/webview/webview_go v0.0.0-...      // Webview2ï¼ˆä¸»ç•Œé¢ï¼‰
)
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd server-go
go mod tidy
```

### 2. ç¼–è¯‘è¿è¡Œ

```bash
# å¼€å‘æ¨¡å¼
go run main.go

# ç¼–è¯‘ä¸º Windows å¯æ‰§è¡Œæ–‡ä»¶
go build -o dy-live-monitor.exe main.go
```

### 3. é…ç½®

é¦–æ¬¡è¿è¡Œä¼šç”Ÿæˆ `config.json`ï¼š

```json
{
  "server": {
    "port": 8080
  },
  "database": {
    "path": "./data.db"
  },
  "license": {
    "server_url": "https://license.example.com",
    "public_key_path": "./rsa_public.pem",
    "local_path": "./license.dat"
  }
}
```

---

## ğŸ“ å¼€å‘è®¡åˆ’

### é˜¶æ®µ 1ï¼šåŸºç¡€æ¡†æ¶ï¼ˆå·²å®Œæˆï¼‰
- âœ… é¡¹ç›®ç»“æ„æ­å»º
- âœ… é…ç½®ç®¡ç†
- âœ… æ•°æ®åº“è®¾è®¡
- âœ… è®¸å¯è¯æ¡†æ¶
- âœ… WebSocket æœåŠ¡å™¨æ¡†æ¶

### é˜¶æ®µ 2ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆè¿›è¡Œä¸­ï¼‰
- ğŸš§ Protobuf è§£æå™¨ç§»æ¤
- ğŸš§ ä¸»ç•Œé¢å¼€å‘
- ğŸš§ æ•°æ®çœ‹æ¿

### é˜¶æ®µ 3ï¼šé«˜çº§åŠŸèƒ½
- â³ Webview2 Fallback
- â³ ä¸»æ’­ç®¡ç†
- â³ ç¤¼ç‰©ç»‘å®š
- â³ åˆ†æ®µè®°åˆ†

### é˜¶æ®µ 4ï¼šä¼˜åŒ–ä¸éƒ¨ç½²
- â³ æ€§èƒ½ä¼˜åŒ–
- â³ æ‰“åŒ…ä¸å®‰è£…ç¨‹åº
- â³ ç”¨æˆ·æ–‡æ¡£

---

## ğŸ¤ ä¸ Node.js ç‰ˆæœ¬çš„å¯¹åº”å…³ç³»

| Node.js (`server/`) | Go (`server-go/`) | çŠ¶æ€ |
|---------------------|-------------------|------|
| `server.js` | `internal/server/websocket.go` | âœ… æ¡†æ¶å®Œæˆ |
| `dy_ws_msg.js` | `internal/parser/douyin.go` | ğŸš§ å¾…ç§»æ¤ |
| SQLite (éšå¼) | `internal/database/database.go` | âœ… å®Œæˆ |
| æ—  | `internal/license/` | âœ… æ–°å¢ |
| æ—  | `internal/ui/systray.go` | âœ… æ¡†æ¶å®Œæˆ |

---

## âš ï¸  æ³¨æ„äº‹é¡¹

1. **Protobuf è§£ææ˜¯æ ¸å¿ƒ**ï¼š`parser/douyin.go` å¿…é¡»å®Œå…¨ç§»æ¤ `dy_ws_msg.js` çš„é€»è¾‘ã€‚
2. **è®¸å¯è¯ç³»ç»Ÿ**ï¼šéœ€è¦ç”Ÿæˆ RSA å¯†é’¥å¯¹ï¼Œå…¬é’¥åµŒå…¥å®¢æˆ·ç«¯ã€‚
3. **CGO ä¾èµ–**ï¼š`go-sqlite3` å’Œ `fyne` éœ€è¦ CGOï¼ŒWindows ç¼–è¯‘éœ€è¦ MinGW-w64ã€‚
4. **OpenGL ä¾èµ–**ï¼šFyne éœ€è¦ OpenGL 2.0+ æ”¯æŒï¼ˆé€šå¸¸ç³»ç»Ÿå·²åŒ…å«ï¼‰ã€‚

---

## ğŸ”— ç›¸å…³é¡¹ç›®

- `browser-monitor/` - æµè§ˆå™¨ç›‘æ§æ’ä»¶
- `server-active/` - è®¸å¯è¯æˆæƒæœåŠ¡ï¼ˆå¾…å¼€å‘ï¼‰
- `server/` - Node.js åŸå‹ï¼ˆå‚è€ƒå®ç°ï¼‰

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨å•†ä¸šè®¸å¯è¯ï¼Œæœªç»æˆæƒä¸å¾—ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚
