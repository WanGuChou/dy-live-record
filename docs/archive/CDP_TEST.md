# CDP Monitor 测试指南

## 🎯 完整测试流程

### 前置准备

1. ✅ Node.js 已安装
2. ✅ Chrome/Edge 浏览器
3. ✅ 已卸载旧版本插件（如果有）

---

## 📝 测试步骤

### 第1步：启动服务器

```bash
cd /workspace/server
npm install  # 首次运行
npm start
```

**验证服务器启动成功：**

应该看到类似输出：
```
════════════════════════════════════════════════════════════════════════════════
CDP Monitor 服务器已启动
地址: ws://localhost:8080/monitor
════════════════════════════════════════════════════════════════════════════════

监控内容:
  ✅ 所有 HTTP/HTTPS 请求 (使用 Chrome DevTools Protocol)
  ✅ WebSocket 连接创建
  ✅ WebSocket 握手过程
  ✅ WebSocket 发送的所有消息
  ✅ WebSocket 接收的所有消息
  ✅ WebSocket 连接关闭

等待客户端连接...
```

✅ **服务器OK**

---

### 第2步：安装插件

⚠️ **重要**: v2.0需要完全卸载旧版本！

1. 打开 `chrome://extensions/`

2. **如果有旧版本**:
   - 点击"移除"
   - 确认删除

3. 启用"开发者模式"

4. 点击"加载已解压的扩展程序"

5. 选择: `/workspace/dy-live-record/brower-monitor`

6. **授权debugger权限**（重要！）
   - 系统会提示"此扩展程序要求调试权限"
   - 点击"添加扩展程序"

**验证插件安装成功：**

- 插件列表中显示 "CDP Monitor"
- 版本显示 "2.0.0"
- 无错误提示

✅ **插件OK**

---

### 第3步：配置插件

1. 点击插件图标

2. 应该看到：
   ```
   🔬 CDP Monitor
   Chrome DevTools Protocol 深度监控
   v2.0.0
   ```

3. 配置：
   - 服务器地址: `ws://localhost:8080/monitor`
   - 过滤关键字: 留空（测试时监控所有）
   - 启用监控: ✅ 打开

4. 点击"测试连接"
   - 应该显示: ✅ 连接测试成功！

5. 点击"保存配置"
   - 应该显示: ✅ 配置已保存 - 监控已启用

6. 查看状态：
   - 服务器状态: 已连接 (绿点)
   - 活跃标签页: 应显示数字
   - WebSocket连接: 0

**验证配置成功：**

查看服务器日志，应该看到：
```
╔══════════════════════════════════════════════════════════════════════════════╗
║ [2025-11-15...] 新客户端已连接
║ IP: ::ffff:127.0.0.1
║ 当前连接数: 1
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│ [2025-11-15...] ✅ 客户端连接确认
│ 监控方法: CDP
└──────────────────────────────────────────────────────────────────────────────┘
```

✅ **配置OK**

---

### 第4步：测试 HTTP/HTTPS 请求捕获

#### 测试A: 访问简单网站

1. 打开新标签页
2. 访问: https://www.baidu.com
3. 等待页面加载完成

**在服务器日志中查找：**

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 📤 HTTP 请求 #1
├──────────────────────────────────────────────────────────────────────────────┤
│ 方法: GET
│ URL: https://www.baidu.com/
│ 资源类型: Document
│ 标签页ID: ...
│ 请求ID: ...
│ 请求头:
│     accept: text/html,application/xhtml+xml...
│     user-agent: Mozilla/5.0...
│ 时间: ...
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ 📥 HTTP 响应
├──────────────────────────────────────────────────────────────────────────────┤
│ 状态码: 200 OK
│ URL: https://www.baidu.com/
│ 资源类型: Document
│ MIME类型: text/html
│ 响应头:
│     content-type: text/html; charset=utf-8
│     server: BWS/1.1
│     ...
└──────────────────────────────────────────────────────────────────────────────┘
```

应该还能看到CSS、JavaScript、图片等资源请求。

**验证点：**
- ✅ 捕获到主页面请求
- ✅ 捕获到资源请求 (CSS/JS/图片)
- ✅ 显示完整的请求头
- ✅ 显示完整的响应头
- ✅ 状态码正确

✅ **HTTP请求捕获OK**

---

### 第5步：测试 WebSocket 连接和消息

#### 方法1: 使用测试网站

1. 访问: https://www.websocket.org/echo.html

2. 在页面上点击 "Connect"

3. 在 "Message" 输入框输入: `Hello from test!`

4. 点击 "Send"

**在服务器日志中查找：**

```
╔══════════════════════════════════════════════════════════════════════════════╗
║ 🔌 WebSocket 创建 #1
╠══════════════════════════════════════════════════════════════════════════════╣
║ 完整URL: wss://echo.websocket.org/?encoding=text
║ 标签页ID: ...
║ 请求ID: ...
║ 时间: ...
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│ 🤝 WebSocket 握手请求
├──────────────────────────────────────────────────────────────────────────────┤
│ URL: wss://echo.websocket.org/?encoding=text
│ 请求ID: ...
│ 握手请求头:
│     Upgrade: websocket
│     Connection: Upgrade
│     Sec-WebSocket-Key: ...
│     Sec-WebSocket-Version: 13
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ ✅ WebSocket 握手响应
├──────────────────────────────────────────────────────────────────────────────┤
│ 状态码: 101 Switching Protocols
│ URL: wss://echo.websocket.org/?encoding=text
│ 握手响应头:
│     Upgrade: websocket
│     Connection: Upgrade
│     Sec-WebSocket-Accept: ...
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ 📤 WebSocket 发送消息
├──────────────────────────────────────────────────────────────────────────────┤
│ WebSocket URL: wss://echo.websocket.org/?encoding=text
│ Opcode: 1 (text frame)
│ Mask: true
│ 消息内容:
│   Hello from test!
│ 消息长度: 16 字符
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ 📥 WebSocket 接收消息
├──────────────────────────────────────────────────────────────────────────────┤
│ WebSocket URL: wss://echo.websocket.org/?encoding=text
│ Opcode: 1 (text frame)
│ Mask: false
│ 消息内容:
│   Hello from test!
│ 消息长度: 16 字符
└──────────────────────────────────────────────────────────────────────────────┘
```

**验证点：**
- ✅ 捕获WebSocket创建
- ✅ 捕获握手请求和响应
- ✅ 捕获发送的消息内容
- ✅ 捕获接收的消息内容
- ✅ URL完整显示

#### 方法2: 在Console中手动测试

1. 打开任意网页
2. 按 F12 打开开发者工具
3. 切换到 Console 标签
4. 执行以下代码：

```javascript
const ws = new WebSocket('wss://echo.websocket.org/');

ws.onopen = () => {
  console.log('✅ WebSocket opened');
  ws.send('Test message from console');
};

ws.onmessage = (e) => {
  console.log('📥 Received:', e.data);
  ws.close();
};

ws.onclose = () => {
  console.log('🔌 WebSocket closed');
};
```

**在服务器应该看到完整的WebSocket生命周期。**

✅ **WebSocket捕获OK**

---

### 第6步：测试过滤功能

1. 打开插件配置

2. 设置过滤关键字: `baidu`

3. 保存配置

4. 访问 https://www.baidu.com
   - 应该看到请求被发送到服务器

5. 访问 https://www.google.com
   - 服务器不应收到这些请求（被过滤掉）

6. 查看插件的Service Worker日志：
   ```
   chrome://extensions/
   → 找到 CDP Monitor
   → 点击 "Service Worker"
   ```

7. 应该看到：
   - baidu.com的请求：✅ 发送
   - google.com的请求：记录但不发送

✅ **过滤功能OK**

---

### 第7步：测试标签页管理

1. 查看插件状态：
   - 活跃标签页数量应该 > 0

2. 打开多个标签页

3. 每打开一个新标签页，数量应该增加

4. 关闭标签页，数量应该减少

5. 查看Service Worker日志：
   ```
   ✅ 调试器已附加到标签页 123
   📡 Network 已启用 (标签页 123)
   ```

✅ **标签页管理OK**

---

## 🎯 完整验证清单

### 基础功能
- [ ] 服务器正常启动
- [ ] 插件正常安装（v2.0.0）
- [ ] debugger权限已授予
- [ ] 配置界面正常
- [ ] 能连接到服务器

### HTTP/HTTPS 监控
- [ ] 捕获主页面请求
- [ ] 捕获子资源（CSS/JS/图片）
- [ ] 显示完整请求头
- [ ] 显示完整响应头
- [ ] 显示HTTP方法
- [ ] 显示状态码

### WebSocket 监控
- [ ] 捕获WebSocket创建事件
- [ ] 捕获握手请求（包含头部）
- [ ] 捕获握手响应（包含头部）
- [ ] 捕获发送的消息内容
- [ ] 捕获接收的消息内容
- [ ] 捕获WebSocket关闭事件
- [ ] 显示完整的WebSocket URL

### 高级功能
- [ ] 过滤功能正常工作
- [ ] 标签页计数正确
- [ ] WebSocket计数正确
- [ ] 多标签页正常工作
- [ ] Service Worker日志正常

### 服务器输出
- [ ] 日志格式清晰易读
- [ ] 包含所有必要信息
- [ ] 请求路径完整
- [ ] WebSocket消息内容完整
- [ ] 时间戳正确

---

## 🐛 常见问题排查

### Q: 插件安装后显示错误

**解决方案：**
1. 检查是否完全卸载了旧版本
2. 清除浏览器缓存
3. 重新加载插件
4. 检查manifest.json是否正确

### Q: 看不到WebSocket消息

**解决方案：**
1. 确认版本是 v2.0.0
2. 确认调试器权限已授予
3. 查看Service Worker日志是否有错误
4. 确认WebSocket URL没有被过滤掉

### Q: Service Worker频繁重启

**解决方案：**
1. 不要关闭开发者工具
2. 在 chrome://extensions/ 中保持插件页面打开
3. 这是Chrome的正常行为，不影响功能

### Q: 服务器收不到消息

**解决方案：**
1. 检查防火墙
2. 确认服务器地址配置正确
3. 测试连接功能
4. 查看Service Worker日志

---

## 📊 性能测试

### 测试场景1: 普通网页

**网站**: https://www.baidu.com

**预期**:
- 请求数: 20-50个
- 服务器日志: 清晰可读
- 浏览器响应: 正常，无延迟

### 测试场景2: 复杂网页

**网站**: https://www.bilibili.com

**预期**:
- 请求数: 100-200个
- 可能有WebSocket连接
- 日志量较大但仍可管理

### 测试场景3: WebSocket密集

**网站**: 直播网站或聊天应用

**预期**:
- 大量WebSocket消息
- 使用过滤功能减少日志
- 服务器CPU和内存占用增加

---

## ✅ 测试完成标志

如果以上所有测试通过，说明CDP Monitor工作完美！

**最终确认：**
1. ✅ HTTP/HTTPS请求完整捕获
2. ✅ WebSocket连接和消息完整捕获
3. ✅ 服务器日志详细清晰
4. ✅ 过滤功能正常
5. ✅ 无明显性能问题
6. ✅ 多标签页支持正常

---

**测试版本**: v2.0.0  
**测试日期**: 2025-11-15  
**使用CDP**: Chrome DevTools Protocol 1.3
