# 调试指南 - 浏览器插件与WebSocket连接

## 🎯 目标

确保浏览器插件能够成功连接到WebSocket服务器，并能正常发送/接收消息。

---

## 📝 调试步骤

### 步骤 1: 启动服务器

```bash
cd server
npm start
```

**预期输出：**
```
============================================================
✅ WebSocket服务器已成功启动
============================================================

📡 服务器信息:
  - 端口: 8080
  - 路径: /monitor

🌐 连接地址:
  - 本地: ws://localhost:8080/monitor
  - 局域网: ws://192.168.x.x:8080/monitor

💡 提示: 在浏览器插件中配置上述任一地址
============================================================

⏳ 等待客户端连接...
```

✅ **如果看到此输出，服务器已正确启动**

❌ **如果看到错误，可能的原因：**
- 端口8080被占用 → 修改 `server.js` 中的端口号
- 依赖未安装 → 运行 `npm install`

---

### 步骤 2: 测试服务器连接（可选但推荐）

在**新终端**中运行测试脚本：

```bash
cd server
node test-connection.js
```

**预期输出：**
```
============================================================
🧪 WebSocket连接测试
============================================================

📡 目标服务器: ws://localhost:8080/monitor
⏳ 正在连接...

✅ 连接成功建立！

📤 发送测试消息:
{
  "type": "test",
  "message": "Hello from test script",
  "timestamp": "2025-11-15T10:00:00.000Z"
}

✅ 消息已发送
⏳ 等待服务器响应...

📥 收到服务器响应:
{
  "type": "ack",
  "originalType": "test",
  "received": true,
  "timestamp": "2025-11-15T10:00:00.000Z"
}

============================================================
✅ 测试成功！服务器工作正常
============================================================
```

同时，在服务器终端中应该看到：

```
============================================================
[时间] 🎉 新客户端已连接
============================================================
客户端信息:
  - IP地址: ::1
  - 端口: xxxxx
  - User-Agent: ...
  - Origin: 未知
  - 当前总连接数: 1

[时间] 📤 已发送欢迎消息

[时间] 收到消息:
  类型: test
  ⚠️  未知消息类型
  时间戳: 2025-11-15T10:00:00.000Z
```

✅ **如果测试成功，说明服务器完全正常，可以继续下一步**

---

### 步骤 3: 配置浏览器插件

#### 3.1 打开插件配置

1. 点击浏览器工具栏中的插件图标
2. 在弹出窗口中：
   - **WebSocket服务器地址**: `ws://localhost:8080/monitor`
   - ⚠️ **重要**: 必须是 `ws://` 开头，不是 `wss://`
   - ⚠️ **重要**: 包含完整路径 `/monitor`

#### 3.2 测试连接

1. 点击 "**测试连接**" 按钮
2. 应该显示 "连接测试成功！"

#### 3.3 保存并启用

1. 点击 "**保存配置**"
2. 开启 "**启用监控**" 开关
3. 连接状态应该变为绿色 "**已连接**"

---

### 步骤 4: 查看插件详细日志

#### Chrome浏览器：

```
1. 打开 chrome://extensions/
2. 找到 "URL & WebSocket Monitor" 插件
3. 点击 "Service Worker" 或 "service worker" 链接
4. 查看 Console 标签
```

#### Edge浏览器：

```
1. 打开 edge://extensions/
2. 找到插件
3. 点击 "检查视图" 或 "Inspect views"
4. 查看 Console 标签
```

#### 预期看到的日志（成功连接）：

```javascript
[2025-11-15T10:00:00.000Z] [URL Monitor] 开始加载配置...
[2025-11-15T10:00:00.001Z] [URL Monitor] 配置已加载:
  {serverUrl: "ws://localhost:8080/monitor", isEnabled: true, wsState: undefined}

[2025-11-15T10:00:00.002Z] [URL Monitor] 监控已启用，开始连接WebSocket...

[2025-11-15T10:00:00.003Z] [URL Monitor] connectWebSocket 被调用
  {serverUrl: "ws://localhost:8080/monitor", currentState: undefined, isEnabled: true}

[2025-11-15T10:00:00.004Z] [URL Monitor] 🔌 正在创建WebSocket连接...
  {url: "ws://localhost:8080/monitor"}

[2025-11-15T10:00:00.010Z] [URL Monitor] ✅ WebSocket连接成功建立！
  {readyState: 1, url: "ws://localhost:8080/monitor"}

[2025-11-15T10:00:00.011Z] [URL Monitor] 📤 发送连接确认消息:
  {type: "connection", status: "connected", timestamp: "2025-11-15T10:00:00.011Z"}

[2025-11-15T10:00:00.012Z] [URL Monitor] 尝试发送消息
  {messageType: "connection", wsState: "1 (OPEN)", isConnected: true}

[2025-11-15T10:00:00.013Z] [URL Monitor] ✅ 消息发送成功:
  {type: "connection", status: "connected", timestamp: "2025-11-15T10:00:00.011Z"}

[2025-11-15T10:00:00.020Z] [URL Monitor] 📥 收到服务器消息:
  {data: "{\"type\":\"welcome\",\"message\":\"欢迎连接到URL监控服务器\",\"timestamp\":\"...\"}", type: "message"}
```

---

### 步骤 5: 查看服务器日志

当浏览器插件连接时，服务器应该输出：

```
============================================================
[2025-11-15T10:00:00.000Z] 🎉 新客户端已连接
============================================================
客户端信息:
  - IP地址: ::1 或 127.0.0.1
  - 端口: 50123
  - User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...
  - Origin: chrome-extension://xxxxxxxxxxxxx
  - 当前总连接数: 1

[2025-11-15T10:00:00.001Z] 📤 已发送欢迎消息

[2025-11-15T10:00:00.010Z] 收到消息:
  类型: connection
  状态: connected
  ✅ 客户端连接确认
  时间戳: 2025-11-15T10:00:00.000Z
------------------------------------------------------------
```

✅ **如果看到这些日志，连接完全成功！**

---

### 步骤 6: 测试URL监控功能

1. 在浏览器中**打开新标签页**
2. 访问任意网站，例如 `https://www.baidu.com`
3. 检查服务器日志，应该看到：

```
[时间] 收到消息:
  类型: url_change
  标签页ID: 12345
  URL: https://www.baidu.com/
  标题: 百度一下，你就知道
  🔄 URL已变化
  时间戳: 2025-11-15T10:00:00.000Z
------------------------------------------------------------
```

✅ **如果看到URL变化的消息，一切正常！**

---

## 🐛 常见问题诊断

### 问题 1: 插件日志中看不到任何输出

**原因：**
- Service Worker未激活
- 插件未正确安装

**解决：**
1. 重新加载插件：chrome://extensions/ → 点击刷新按钮
2. 点击 "Service Worker" 链接激活
3. 在插件配置界面操作一下（点击测试连接）

---

### 问题 2: 插件日志显示 "❌ WebSocket错误"

**原因：**
- 服务器未启动
- 地址配置错误
- 防火墙阻止

**解决：**
1. 确认服务器正在运行
2. 检查地址：必须是 `ws://localhost:8080/monitor`
3. 不要使用 `wss://`（除非配置了SSL）
4. 运行测试脚本验证服务器：`node test-connection.js`

---

### 问题 3: 插件显示"连接中..."一直不变

**原因：**
- WebSocket一直处于CONNECTING状态
- 服务器路径不匹配

**解决：**
1. 检查完整地址包含 `/monitor`
2. 重启服务器
3. 重新加载插件
4. 查看浏览器插件详细日志

---

### 问题 4: 服务器收不到消息

**原因：**
- "启用监控"开关未打开
- WebSocket连接未建立

**解决：**
1. 打开插件配置界面
2. 确认 "启用监控" 开关是**蓝色**（已打开）
3. 确认状态显示**绿色** "已连接"
4. 点击"保存配置"

---

### 问题 5: 插件连接成功但服务器没反应

**检查清单：**
- [ ] 是否运行了多个服务器实例？
  ```bash
  ps aux | grep node
  # 停止多余的进程
  ```
- [ ] 是否在查看正确的终端窗口？
- [ ] 服务器代码是否是最新版本？
  ```bash
  cd server
  git pull  # 如果使用Git
  npm install
  npm start
  ```

---

## 📊 日志对照表

| 操作 | 插件日志关键词 | 服务器日志关键词 | 状态 |
|------|---------------|-----------------|------|
| 启动插件 | "开始加载配置" | - | ⚠️ 初始化 |
| 建立连接 | "✅ WebSocket连接成功建立" | "🎉 新客户端已连接" | ✅ 已连接 |
| 发送消息 | "✅ 消息发送成功" | "收到消息" | ✅ 通信正常 |
| 连接错误 | "❌ WebSocket错误" | - | ❌ 连接失败 |
| 连接断开 | "🔌 WebSocket连接已关闭" | "客户端已断开连接" | ⚠️ 已断开 |

---

## 🎓 理解 WebSocket 状态

插件日志中的 WebSocket 状态：

- **0 (CONNECTING)**: 正在连接
- **1 (OPEN)**: 已连接，可以通信
- **2 (CLOSING)**: 正在关闭
- **3 (CLOSED)**: 已关闭

正常情况下应该快速从 0 变为 1。

---

## 💡 调试技巧

### 1. 同时查看两个日志

- **左侧终端**: 服务器日志
- **右侧浏览器**: 插件 Service Worker 日志
- 对比两边的时间戳，确认消息流向

### 2. 使用时间戳关联

所有日志都包含 ISO 8601 时间戳，方便追踪消息流程。

### 3. 清空日志重新测试

- 服务器：重启服务器（Ctrl+C，然后 npm start）
- 插件：在 DevTools Console 中点击清空按钮

---

## 📚 更多帮助

- **完整故障排查**: 查看 [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)
- **项目文档**: 查看 [README.md](./README.md)
- **快速入门**: 查看 [dy-live-record/brower-monitor/QUICKSTART.md](./dy-live-record/brower-monitor/QUICKSTART.md)

---

**祝调试顺利！** 🎉

如果按照此指南仍然无法解决问题，请收集完整的日志信息提交Issue。
